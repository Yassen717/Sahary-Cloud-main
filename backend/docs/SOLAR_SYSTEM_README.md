# نظام مراقبة الطاقة الشمسية - Sahary Cloud

## نظرة عامة

نظام مراقبة الطاقة الشمسية هو جزء أساسي من منصة Sahary Cloud، يوفر مراقبة شاملة لإنتاج واستهلاك الطاقة الشمسية، مع نظام تنبيهات وطوارئ متقدم.

## المكونات الرئيسية

### 1. خدمة مراقبة الطاقة الشمسية (Solar Service)
- جمع بيانات الإنتاج والاستهلاك
- حساب الكفاءة
- حساب التأثير البيئي
- تخزين البيانات التاريخية

### 2. خدمة التنبيهات والطوارئ (Solar Alert Service)
- مراقبة مستويات الطاقة
- إنشاء التنبيهات التلقائية
- تفعيل خطط الطوارئ
- إدارة حالات النظام

### 3. جامع البيانات (Solar Data Collector)
- جمع البيانات كل 15 دقيقة
- مراقبة تلقائية للمستويات
- تسجيل البيانات في قاعدة البيانات

## الميزات

### مراقبة الطاقة
- ✅ مراقبة الإنتاج في الوقت الفعلي
- ✅ حساب الاستهلاك من الخوادم النشطة
- ✅ حساب الكفاءة
- ✅ مراقبة مستوى البطارية
- ✅ بيانات تاريخية مفصلة

### التأثير البيئي
- ✅ حساب CO2 المتوفر
- ✅ معادل الأشجار المزروعة
- ✅ تقارير بيئية شاملة
- ✅ مقارنة مع الطاقة التقليدية

### نظام التنبيهات
- ✅ تنبيهات انخفاض الإنتاج
- ✅ تنبيهات انخفاض البطارية
- ✅ تنبيهات الاستهلاك العالي
- ✅ مستويات خطورة متعددة (INFO, WARNING, CRITICAL, EMERGENCY)
- ✅ إشعارات بريد إلكتروني للمسؤولين

### نظام الطوارئ
- ✅ خطط طوارئ تلقائية
- ✅ التبديل للطاقة الاحتياطية
- ✅ تقليل الأحمال غير الضرورية
- ✅ سجلات الطوارئ
- ✅ إعادة تعيين يدوية للنظام

## البنية التقنية

```
Solar Monitoring System
│
├── Services
│   ├── solarService.js          # خدمة مراقبة الطاقة
│   └── solarAlertService.js     # خدمة التنبيهات والطوارئ
│
├── Controllers
│   └── solarController.js       # معالجات API
│
├── Routes
│   └── solar.js                 # مسارات API
│
├── Jobs
│   └── solarDataCollector.js   # جامع البيانات المجدول
│
├── Models (Prisma)
│   ├── SolarData               # بيانات الطاقة
│   ├── SolarAlert              # التنبيهات
│   ├── EmergencyLog            # سجلات الطوارئ
│   └── SystemStatus            # حالة النظام
│
└── Tests
    ├── solar.test.js           # اختبارات الوحدة
    ├── solarAlert.test.js      # اختبارات التنبيهات
    └── solarAPI.test.js        # اختبارات التكامل
```

## التثبيت والإعداد

### 1. متطلبات النظام
```bash
Node.js >= 18.0.0
PostgreSQL >= 13
Redis >= 6
```

### 2. تثبيت التبعيات
```bash
npm install
```

### 3. إعداد قاعدة البيانات
```bash
npx prisma generate
npx prisma migrate dev
```

### 4. متغيرات البيئة
```env
# Solar Energy Monitoring API
SOLAR_API_URL="http://localhost:8080"
SOLAR_API_KEY="your-solar-monitoring-api-key"
SOLAR_COLLECTION_SCHEDULE="*/15 * * * *"

# Solar Alert Thresholds
LOW_PRODUCTION_THRESHOLD=20
CRITICAL_PRODUCTION_THRESHOLD=10
LOW_BATTERY_THRESHOLD=30
CRITICAL_BATTERY_THRESHOLD=15
HIGH_CONSUMPTION_THRESHOLD=90
```

## الاستخدام

### بدء النظام
```bash
npm start
```

سيتم تشغيل:
- خادم API على المنفذ 3000
- جامع البيانات الشمسية (كل 15 دقيقة)
- نظام المراقبة والتنبيهات

### APIs المتاحة

#### للمستخدمين
- `GET /api/v1/solar/status` - حالة النظام
- `GET /api/v1/solar/production` - الإنتاج الحالي
- `GET /api/v1/solar/consumption` - الاستهلاك الحالي
- `GET /api/v1/solar/environmental-impact` - التأثير البيئي
- `GET /api/v1/solar/statistics` - الإحصائيات
- `GET /api/v1/solar/history` - البيانات التاريخية

#### للمسؤولين فقط
- `GET /api/v1/solar/battery` - مستوى البطارية
- `POST /api/v1/solar/collect` - جمع البيانات يدوياً
- `GET /api/v1/solar/alerts` - التنبيهات النشطة
- `PUT /api/v1/solar/alerts/:id/resolve` - حل تنبيه
- `GET /api/v1/solar/emergency-logs` - سجلات الطوارئ
- `GET /api/v1/solar/system-state` - حالة النظام
- `POST /api/v1/solar/reset-state` - إعادة تعيين النظام
- `POST /api/v1/solar/emergency/:severity` - تفعيل خطة طوارئ

## الاختبارات

### تشغيل جميع الاختبارات
```bash
npm test
```

### اختبارات محددة
```bash
# اختبارات خدمة الطاقة الشمسية
npm test -- solar.test.js

# اختبارات التنبيهات
npm test -- solarAlert.test.js

# اختبارات API
npm test -- solarAPI.test.js
```

### تغطية الاختبارات
```bash
npm run test:coverage
```

## نظام التنبيهات

### مستويات الخطورة

#### INFO
- معلومات عامة
- لا تتطلب إجراء فوري

#### WARNING
- تحذير من مشكلة محتملة
- يتطلب مراقبة
- إشعارات للمسؤولين

#### CRITICAL
- مشكلة حرجة
- يتطلب إجراء فوري
- تفعيل خطة الطوارئ
- إشعارات عاجلة للمسؤولين

#### EMERGENCY
- حالة طوارئ
- إجراءات تلقائية فورية
- إشعارات عاجلة لجميع المسؤولين

### أنواع التنبيهات

1. **LOW_PRODUCTION** - انخفاض الإنتاج (< 20%)
2. **CRITICAL_LOW_PRODUCTION** - انخفاض حرج في الإنتاج (< 10%)
3. **LOW_BATTERY** - انخفاض البطارية (< 30%)
4. **CRITICAL_LOW_BATTERY** - انخفاض حرج في البطارية (< 15%)
5. **HIGH_CONSUMPTION** - استهلاك عالي (> 90%)

## خطط الطوارئ

### خطة التحذير (WARNING)
1. تحضير نظام الطاقة الاحتياطية
2. إشعار المسؤولين
3. تسجيل الحدث

### خطة الحرجة (CRITICAL)
1. التبديل للطاقة الاحتياطية
2. تقليل الأحمال غير الضرورية
3. إشعار عاجل لجميع المسؤولين
4. تسجيل مفصل للحدث

## المراقبة والصيانة

### مراقبة يومية
- ✅ فحص حالة النظام
- ✅ مراجعة التنبيهات النشطة
- ✅ مراقبة مستوى البطارية

### مراقبة أسبوعية
- ✅ مراجعة سجلات الطوارئ
- ✅ تحليل أنماط الاستهلاك
- ✅ مراجعة الإحصائيات

### صيانة شهرية
- ✅ مراجعة عتبات التنبيهات
- ✅ تحليل البيانات التاريخية
- ✅ تحديث التوثيق

## استكشاف الأخطاء

### المشكلة: لا يتم جمع البيانات
**الحل:**
1. تحقق من تشغيل جامع البيانات
2. تحقق من اتصال API الطاقة الشمسية
3. راجع سجلات الأخطاء

### المشكلة: التنبيهات لا تعمل
**الحل:**
1. تحقق من إعدادات البريد الإلكتروني
2. تحقق من عتبات التنبيهات
3. راجع سجلات التنبيهات

### المشكلة: بيانات غير دقيقة
**الحل:**
1. تحقق من تكوين API
2. راجع حسابات الاستهلاك
3. تحقق من بيانات الخوادم النشطة

## الأمان

### المصادقة
- جميع endpoints تتطلب JWT token
- endpoints المسؤولين تتطلب دور ADMIN أو SUPER_ADMIN

### الصلاحيات
- المستخدمون: قراءة البيانات فقط
- المسؤولون: قراءة وكتابة وإدارة

### حماية البيانات
- تشفير البيانات الحساسة
- Rate limiting على APIs
- تسجيل جميع العمليات الحرجة

## الأداء

### التحسينات
- ✅ Caching للبيانات المتكررة
- ✅ Pagination للقوائم الطويلة
- ✅ Indexing لقاعدة البيانات
- ✅ Connection pooling

### المراقبة
- مراقبة استجابة APIs
- مراقبة استخدام الذاكرة
- مراقبة استعلامات قاعدة البيانات

## التطوير المستقبلي

### الميزات المخططة
- [ ] تكامل مع أنظمة طاقة شمسية متعددة
- [ ] تنبؤ بالإنتاج باستخدام AI
- [ ] تطبيق موبايل للمراقبة
- [ ] لوحة تحكم تفاعلية
- [ ] تقارير مخصصة

## المساهمة

للمساهمة في تطوير النظام:
1. Fork المشروع
2. إنشاء branch للميزة الجديدة
3. Commit التغييرات
4. Push للـ branch
5. إنشاء Pull Request

## الدعم

للحصول على الدعم:
- البريد الإلكتروني: support@saharycloud.com
- التوثيق: `/docs/SOLAR_MONITORING_API.md`
- GitHub Issues: [رابط المشروع]

## الترخيص

MIT License - Sahary Cloud Platform

---

**ملاحظة:** هذا النظام جزء من منصة Sahary Cloud لاستضافة الخوادم الافتراضية بالطاقة الشمسية.
